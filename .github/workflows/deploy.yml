name: Deploy to ECS

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com
      DOCKER_REPO: hello-world
      

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Docker Login
      uses: docker/login-action@v3.1.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWD }}

    - name: Build and push Docker images
      id: docker-login
      uses: docker/build-push-action@v5.3.0
      with:
         file: ../app/Dockerfile
         push: true
         tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ github.sha }}
          

    

    - name: Deploy to ECS
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: us-east-1
        CLUSTER_NAME: hello-world-cluster
        SERVICE_NAME: hello-world-service
        TASK_DEFINITION: hello-world-task
        CONTAINER_NAME: hello-world
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "Updating task definition"
        TASK_DEFINITION_ARN=$(aws ecs describe-task-definition --task-definition $TASK_DEFINITION | jq -r '.taskDefinition.taskDefinitionArn')
        
        NEW_TASK_DEFINITION=$(aws ecs register-task-definition \
          --family $TASK_DEFINITION \
          --network-mode "awsvpc" \
          --requires-compatibilities "FARGATE" \
          --cpu "256" \
          --memory "512" \
          --execution-role-arn $(aws iam get-role --role-name ecsTaskExecutionRole | jq -r '.Role.Arn') \
          --container-definitions "[
            {
              \"name\": \"$CONTAINER_NAME\",
              \"image\": \"${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ github.sha }}",
              \"essential\": true,
              \"portMappings\": [
                {
                  \"containerPort\": 3000,
                  \"hostPort\": 3000
                }
              ]
            }
          ]" --region $AWS_REGION | jq -r '.taskDefinition.taskDefinitionArn')
        
        echo "Updating ECS service"
        aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $NEW_TASK_DEFINITION
